# 異世界ファンタジーWeb小説 マルチエージェント執筆システム

## プロジェクト概要

異世界ファンタジーのWeb小説を、Claude Codeのsubagent機能（Task tool）を活用したマルチエージェントチームで自動執筆するシステム。「編集」「作者」「担当者」「想定読者」の4種のエージェントが対話的に協力し、1コマンドで1エピソード（1500〜4000字、標準2000〜3000字）を自動的に執筆・レビュー・改稿する。リビジョン上限到達時は品質ゲートを適用し、最低基準未達の場合はユーザーに手動介入を求める。

## ディレクトリ構成

```
Agentic_Novel/
├── CLAUDE.md                          # このファイル
├── .claude/skills/write-episode/
│   └── SKILL.md                       # /write-episode スキル
├── agents/
│   ├── editor.md                      # 編集エージェント
│   ├── author.md                      # 作者エージェント
│   ├── manager.md                     # 担当者エージェント
│   └── readers/
│       ├── reader-young-male.md       # ユウキ（17歳男性）
│       ├── reader-adult-female.md     # サキ（28歳女性）
│       └── reader-veteran.md          # タツヤ（35歳ベテラン）
├── story/
│   ├── premise.md                     # 作品コンセプト・あらすじ
│   ├── setting.md                     # 世界観設定
│   ├── characters.md                  # 登録人物
│   ├── plot-outline.md                # 全体プロット
│   ├── episode-summaries.md           # 各話あらすじ蓄積
│   ├── writing-guide.md              # 文体・記法ガイド
│   ├── handover-notes.md             # 次話への申し送り事項
│   └── quality-log.md                # 品質トレンド記録
├── episodes/                          # 確定エピソード（.txt）
├── workspace/                         # エージェント間の作業領域
│   ├── current-direction.md           # 編集の方針
│   ├── current-draft.txt              # 作者のドラフト
│   ├── manager-review.md             # 担当者レビュー
│   ├── reader-feedback-young-male.md
│   ├── reader-feedback-adult-female.md
│   ├── reader-feedback-veteran.md
│   ├── consolidated-feedback.md      # 編集が統合したフィードバック（リビジョン時）
│   ├── revision-log.md               # リビジョン履歴
│   ├── discussion-log.md             # ディスカッション記録（実行中のみ存在）
│   └── progress.md                    # 進捗トラッカー（実行中のみ存在）
└── archive/                           # 過去ドラフト保存
    └── episode-XX/
```

## エージェント構成

コアメンバー（編集・作者・担当者）はチームメンバーとしてスポーンされ、SendMessageによる議論が可能。読者はサブエージェント（独立Task）で生の読者反応を提供する。

| エージェント | ファイル | 方式 | 役割 |
|-------------|---------|------|------|
| **編集** | `agents/editor.md` | チームメンバー（Opus） | 全体プロット・設定を踏まえ、各話の創作方針を決定 |
| **作者** | `agents/author.md` | チームメンバー（Opus） | 編集の方針に従い本文を執筆・改稿 |
| **担当者** | `agents/manager.md` | チームメンバー（Sonnet） | ドラフトの品質評価と判定 |
| **読者×3** | `agents/readers/*.md` | サブエージェント | 3ペルソナ視点で感想と★評価 |

### モデル非対称性への対策

担当者（Sonnet）が作者（Opus）に議論で「言い負かされる」リスクを以下で防止:
- **書面先行ルール**: 担当者は `manager-review.md` を書き切ってから議論に参加する
- **判定不変の原則**: 書面に記載した判定は議論で変更しない
- **議論の非対称制限**: 作者→担当者は「意図の説明」のみ許可。「判定への異議」は禁止

## ワークフロー

`/write-episode <番号>` で起動。全ステップ自動実行。

1. **初期化 / 再開判定**: progress.md をチェック。新規なら workspace をクリーン、再開なら中断地点から継続
2. **チーム作成 + コアメンバー一斉スポーン**: 編集・作者・担当者をチームメンバーとしてスポーン
3. **編集（方針策定）**: current-direction.md を出力
4. **方針ディスカッション**: 作者・担当者が方針に意見があれば議論（なければ即時合意で進行）
5. **作者（執筆/改稿）**: current-draft.txt を出力 → **読者3名をバックグラウンドスポーン**
6. **担当者（レビュー）**: manager-review.md を出力（読者は並行してフィードバック生成中）
7. **ドラフトディスカッション**: 作者・編集がレビュー所見に対し意見交換（なければ即時合意で進行）
8. **読者フィードバック回収**: バックグラウンドスポーン済みの読者結果を回収・検証
9. **判定**: OK かつ 読者平均★≥3.5 → 確定（軽微指摘あれば **6.5P ポリッシュ** 経由）/ 要修正 → Step 6.5D へ（最大3回）/ リビジョン上限到達時は品質ゲート適用（最低基準未達なら中断）
   - **6.5P ポリッシュ**: PASS だが軽微な共通指摘がある場合、作者に部分修正を依頼
   - **6.5D リビジョンディスカッション**: 三者で改稿方針を議論 → consolidated-feedback.md を出力 → Step 5 に戻る
10. **確定・保存**: episodes/ に保存、episode-summaries.md に追記、quality-log.md に拡張記録、archive/ にアーカイブ
    - **10a. 申し送り事項更新**: editor が story/handover-notes.md を更新（解決済み項目の処理、新規項目の追加）
11. **プロット更新ディスカッション**: editor と manager が plot-outline.md の更新要否を検討
12. **チームシャットダウン**: 全メンバーにshutdown_request → TeamDelete

## ルール

- コアメンバー間の通信は SendMessage による直接メッセージで行う
- 成果物（方針・ドラフト・レビュー等）は workspace/ 内のファイルとして出力する
- 各エージェントは自分のプロンプトファイル（agents/*.md）に定義された役割に忠実に従う
- story/ 内のファイルは全エージェントが参照する共有設定
- リビジョンは最大3回（`--max-revisions=N` で変更可能）
- エピソードの文字数: 編集が方針策定時にエピソードタイプ（A: 重要回 3000〜4000字 / B: 標準回 2000〜3000字 / C: つなぎ回 1500〜2000字）を指定。未指定時はB
- 読者フィードバックはサブエージェントの並列実行で効率化する
- ディスカッションは自然発生型: 意見がある場合のみ議論、なければ即進行
- ディスカッションの知見は成果物への【〇〇ディスカッション反映】注記と `workspace/discussion-log.md` に記録

## 中断復帰（レジュメ）

セッション中断（レート制限、クラッシュ等）に対する復帰機能:

- `/write-episode N` 実行中、進捗は `workspace/progress.md` に逐次記録される
- セッション中断後に同じ `/write-episode N` を実行すると、自動的に中断地点から再開する
- エピソード番号が異なる progress.md が残っている場合はユーザーに確認を求める
- エピソード確定時（Step 10）に progress.md はアーカイブ後に自動削除される
- チームはセッション間で維持されないため、再開時も Step 2（チーム作成）は必ず実行される
- 手動で `workspace/progress.md` を削除すると強制的に新規開始できる
